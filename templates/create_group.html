{% extends "base.html" %}

{% block content %}
<div class="container">
    <div class="row justify-content-center">
        <div class="col-lg-8">
            <!-- Header Section -->
            <div class="text-center mb-5">
                <div class="header-icon">
                    <i class="fas fa-users"></i>
                </div>
                <h1 class="display-5 fw-bold gradient-text mb-3">Create New Group</h1>
                <p class="lead text-muted">Start splitting bills with your friends in style</p>
            </div>

            <!-- Create Group Form -->
            <div class="create-group-card">
                <form method="POST" id="createGroupForm">
                    <!-- Group Name Field -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-tag"></i>
                            </div>
                            <h5>Group Information</h5>
                        </div>
                        
                        <div class="form-group-enhanced">
                            <label for="group_name" class="form-label-enhanced">
                                <i class="fas fa-users me-2"></i>Group Name
                            </label>
                            <div class="input-group-enhanced">
                                <input type="text" 
                                       class="form-control-enhanced" 
                                       id="group_name" 
                                       name="group_name" 
                                       required 
                                       placeholder="e.g., Saturday Lunch Crew, Weekend Trip, Roommates">
                                <div class="input-icon">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="form-hint">Give your group a memorable name</div>
                        </div>
                    </div>

                    <!-- Group Members Field -->
                    <div class="form-section">
                        <div class="section-header">
                            <div class="section-icon">
                                <i class="fas fa-user-friends"></i>
                            </div>
                            <h5>Group Members</h5>
                        </div>

                        <div class="form-group-enhanced">
                            <label for="members" class="form-label-enhanced">
                                <i class="fas fa-users me-2"></i>Add Members
                            </label>
                            
                            <!-- Members Input Area -->
                            <div class="members-input-container">
                                <div class="input-group-enhanced">
                                    <input type="text" 
                                           class="form-control-enhanced" 
                                           id="memberInput"
                                           placeholder="Enter member name and press Enter, comma, or click +"
                                           autocomplete="off">
                                    <button type="button" class="input-icon-btn" id="addMemberBtn">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <input type="hidden" id="members" name="members" required>
                                
                                <!-- Dynamic Quick Add Suggestions -->
                                <div class="quick-add-suggestions mt-3">
                                    <span class="suggestion-label">Recently used:</span>
                                    <div class="suggestion-tags" id="recentMembers">
                                        {% for member in recent_members %}
                                        <span class="suggestion-tag" data-name="{{ member }}">{{ member }}</span>
                                        {% endfor %}
                                        {% if not recent_members %}
                                        <span class="text-muted">No recent members yet</span>
                                        {% endif %}
                                    </div>
                                </div>

                                <!-- Common Names Suggestions -->
                                <div class="quick-add-suggestions mt-2">
                                    <span class="suggestion-label">Common names:</span>
                                    <div class="suggestion-tags" id="commonMembers">
                                        <span class="suggestion-tag" data-name="Alice">Alice</span>
                                        <span class="suggestion-tag" data-name="Bob">Bob</span>
                                        <span class="suggestion-tag" data-name="Charlie">Charlie</span>
                                        <span class="suggestion-tag" data-name="David">David</span>
                                        <span class="suggestion-tag" data-name="Eve">Eve</span>
                                        <span class="suggestion-tag" data-name="Frank">Frank</span>
                                        <span class="suggestion-tag" data-name="Grace">Grace</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Members Display Area -->
                            <div class="members-display-area">
                                <div class="selected-members" id="selectedMembers">
                                    <div class="no-members-placeholder">
                                        <i class="fas fa-user-plus"></i>
                                        <span>No members added yet. Start typing names above.</span>
                                    </div>
                                </div>
                                <div class="members-count" id="membersCount">
                                    <span>0 members</span>
                                </div>
                            </div>

                            <div class="form-hint">
                                <i class="fas fa-lightbulb me-1"></i>
                                Type names and press Enter, comma, or click the + button to add members
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary-enhanced w-100" id="submitButton" disabled>
                            <i class="fas fa-rocket me-2"></i>
                            Create Awesome Group
                        </button>
                        <a href="{{ url_for('index') }}" class="btn btn-secondary-enhanced w-100 mt-2">
                            <i class="fas fa-arrow-left me-2"></i>
                            Back to Home
                        </a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<style>
/* Add these new styles */
.input-icon-btn {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    border-radius: 8px;
    width: 35px;
    height: 35px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.3s ease;
}

.input-icon-btn:hover {
    transform: translateY(-50%) scale(1.1);
}

.quick-add-suggestions {
    border-left: 3px solid #667eea;
    padding-left: 15px;
    background: #f8f9fa;
    border-radius: 0 8px 8px 0;
    padding: 10px 15px;
}

.suggestion-label {
    font-weight: 600;
    color: #495057;
    font-size: 0.9rem;
    display: block;
    margin-bottom: 8px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const memberInput = document.getElementById('memberInput');
    const membersHidden = document.getElementById('members');
    const selectedMembers = document.getElementById('selectedMembers');
    const membersCount = document.getElementById('membersCount');
    const submitButton = document.getElementById('submitButton');
    const form = document.getElementById('createGroupForm');
    const addMemberBtn = document.getElementById('addMemberBtn');
    
    let members = [];
    
    // Initialize display
    updateMembersDisplay();
    
    // Load recent members from API
    loadRecentMembers();
    
    // Add member on Enter, comma, or button click
    memberInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' || e.key === ',') {
            e.preventDefault();
            addCurrentMember();
        }
    });
    
    // Add member button click
    addMemberBtn.addEventListener('click', function() {
        addCurrentMember();
    });
    
    // Add member from suggestion tags
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('suggestion-tag')) {
            const name = e.target.getAttribute('data-name');
            addMember(name);
            memberInput.value = '';
            memberInput.focus();
        }
    });
    
    function addCurrentMember() {
        const name = memberInput.value.trim();
        if (name) {
            addMember(name);
            memberInput.value = '';
            memberInput.focus();
        }
    }
    
    // Add member function
    function addMember(name) {
        if (name && name.length > 0 && !members.includes(name)) {
            members.push(name);
            updateMembersDisplay();
            updateFormValidation();
            
            // Add to recent members locally
            addToRecentMembers(name);
        }
    }
    
    // Remove member function
    function removeMember(name) {
        members = members.filter(m => m !== name);
        updateMembersDisplay();
        updateFormValidation();
    }
    
    // Update members display
    function updateMembersDisplay() {
        // Update hidden field
        membersHidden.value = members.join(',');
        
        // Update visual display
        if (members.length === 0) {
            selectedMembers.innerHTML = `
                <div class="no-members-placeholder">
                    <i class="fas fa-user-plus"></i>
                    <span>No members added yet. Start typing names above.</span>
                </div>
            `;
        } else {
            selectedMembers.innerHTML = members.map(member => `
                <div class="member-tag">
                    <i class="fas fa-user"></i>
                    ${member}
                    <button type="button" class="remove-member" onclick="removeMember('${member}')">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }
        
        // Update count
        membersCount.innerHTML = `<span>${members.length} member${members.length !== 1 ? 's' : ''}</span>`;
    }
    
    // Update form validation
    function updateFormValidation() {
        const groupName = document.getElementById('group_name').value.trim();
        const isValid = groupName.length > 0 && members.length >= 2;
        
        submitButton.disabled = !isValid;
        
        if (isValid) {
            submitButton.innerHTML = `<i class="fas fa-rocket me-2"></i>Create Awesome Group (${members.length} members)`;
        } else {
            submitButton.innerHTML = `<i class="fas fa-rocket me-2"></i>Create Awesome Group`;
        }
    }
    
    // Load recent members from API
    function loadRecentMembers() {
        fetch('/api/recent_members')
            .then(response => response.json())
            .then(recentMembers => {
                const recentContainer = document.getElementById('recentMembers');
                if (recentMembers.length > 0) {
                    recentContainer.innerHTML = recentMembers.map(member => 
                        `<span class="suggestion-tag" data-name="${member}">${member}</span>`
                    ).join('');
                }
            })
            .catch(error => console.error('Error loading recent members:', error));
    }
    
    // Add to recent members locally
    function addToRecentMembers(name) {
        const recentContainer = document.getElementById('recentMembers');
        const existingTags = Array.from(recentContainer.querySelectorAll('.suggestion-tag'));
        const existingNames = existingTags.map(tag => tag.getAttribute('data-name'));
        
        // Remove if already exists
        if (existingNames.includes(name)) {
            const existingTag = existingTags.find(tag => tag.getAttribute('data-name') === name);
            existingTag.remove();
        }
        
        // Add to beginning
        const newTag = document.createElement('span');
        newTag.className = 'suggestion-tag';
        newTag.setAttribute('data-name', name);
        newTag.textContent = name;
        recentContainer.insertBefore(newTag, recentContainer.firstChild);
        
        // Limit to 8 recent members
        if (existingTags.length >= 8) {
            recentContainer.lastChild.remove();
        }
    }
    
    // Group name validation
    document.getElementById('group_name').addEventListener('input', updateFormValidation);
    
    // Form submission validation
    form.addEventListener('submit', function(e) {
        if (members.length < 2) {
            e.preventDefault();
            alert('Please add at least 2 members to create a group.');
            memberInput.focus();
            return false;
        }
        
        // Add loading state
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Creating Group...';
    });
    
    // Make removeMember function global for onclick
    window.removeMember = removeMember;
});
</script>
{% endblock %}
